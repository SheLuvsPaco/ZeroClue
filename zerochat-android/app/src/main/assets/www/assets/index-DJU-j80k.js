(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();function $(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function w(e,t=!1){const r=$(),n=`_${r}`;return Object.defineProperty(window,n,{value:s=>(t&&Reflect.deleteProperty(window,n),e?.(s)),writable:!1,configurable:!0}),r}async function a(e,t={}){return new Promise((r,n)=>{const s=w(d=>{r(d),Reflect.deleteProperty(window,`_${i}`)},!0),i=w(d=>{n(d),Reflect.deleteProperty(window,`_${s}`)},!0);window.__TAURI_IPC__({cmd:e,callback:s,error:i,...t})})}async function S(e){return a("tauri",e)}async function j(e,t){return S({__tauriModule:"Event",message:{cmd:"unlisten",event:e,eventId:t}})}async function V(e,t,r){return S({__tauriModule:"Event",message:{cmd:"listen",event:e,windowLabel:t,handler:w(r)}}).then(n=>async()=>j(e,n))}var C;(function(e){e.WINDOW_RESIZED="tauri://resize",e.WINDOW_MOVED="tauri://move",e.WINDOW_CLOSE_REQUESTED="tauri://close-requested",e.WINDOW_CREATED="tauri://window-created",e.WINDOW_DESTROYED="tauri://destroyed",e.WINDOW_FOCUS="tauri://focus",e.WINDOW_BLUR="tauri://blur",e.WINDOW_SCALE_FACTOR_CHANGED="tauri://scale-change",e.WINDOW_THEME_CHANGED="tauri://theme-changed",e.WINDOW_FILE_DROP="tauri://file-drop",e.WINDOW_FILE_DROP_HOVER="tauri://file-drop-hover",e.WINDOW_FILE_DROP_CANCELLED="tauri://file-drop-cancelled",e.MENU="tauri://menu",e.CHECK_UPDATE="tauri://update",e.UPDATE_AVAILABLE="tauri://update-available",e.INSTALL_UPDATE="tauri://update-install",e.STATUS_UPDATE="tauri://update-status",e.DOWNLOAD_PROGRESS="tauri://update-download-progress"})(C||(C={}));async function A(e,t){return V(e,null,t)}let v=null,L="",I="";const f=document.getElementById("onboarding"),p=document.getElementById("app"),N=document.getElementById("onboardUsername"),B=document.getElementById("onboardPassword"),l=document.getElementById("onboardSignup"),u=document.getElementById("onboardLogin"),W=document.querySelectorAll(".tab-btn"),z=document.querySelectorAll(".tab-content"),g=document.getElementById("messagesList"),h=document.getElementById("chatFriend"),y=document.getElementById("chatMessage"),M=document.getElementById("chatSend"),D=document.getElementById("addFriendInput"),G=document.getElementById("addFriendBtn"),b=document.getElementById("pendingList"),_=document.getElementById("friendsListContent"),K=document.getElementById("profileUsername"),Z=document.getElementById("profileDeviceId"),J=document.getElementById("copyInviteLink"),O=document.getElementById("inviteLinkDisplay"),P=document.getElementById("inviteLinkText");W.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");k(t)})});function k(e){W.forEach(t=>{t.getAttribute("data-tab")===e?(t.classList.add("border-blue-600","text-blue-600"),t.classList.remove("border-transparent","text-gray-600")):(t.classList.remove("border-blue-600","text-blue-600"),t.classList.add("border-transparent","text-gray-600"))}),z.forEach(t=>{t.id===`${e}-tab`?t.classList.remove("hidden"):t.classList.add("hidden")}),e==="contacts"&&c(),e==="profile"&&x()}const m="http://127.0.0.1:8080";async function U(){try{if(await a("set_base",{base:m}),!await a("load_creds").catch(()=>null)){f.classList.remove("hidden"),p.classList.add("hidden");return}const t=await a("get_me");L=t.username,I=t.device_id,f.classList.add("hidden"),p.classList.remove("hidden"),H(),c(),x()}catch(e){console.error("Onboarding check failed:",e),f.classList.remove("hidden"),p.classList.add("hidden")}}async function R(){await a("upload_identity_and_keypackage");const e=await a("get_me");L=e.username,I=e.device_id,f.classList.add("hidden"),p.classList.remove("hidden"),H(),c(),x()}const E=document.getElementById("errorMessage");function o(e){E.textContent=e,E.classList.remove("hidden")}function F(){E.classList.add("hidden")}l.addEventListener("click",async()=>{F();try{const e=N.value.trim(),t=B.value.trim();if(!e||!t){o("Please enter username and password");return}if(t.length<8){o("Password must be at least 8 characters");return}l.disabled=!0,u.disabled=!0,await a("set_base",{base:m}),await a("signup",{username:e,password:t,base_url:m}),await R()}catch(e){const t=e?.message||e?.toString()||String(e)||"Unknown error";console.error("Signup error:",t),t.includes("Network error")||t.includes("error sending request")?o("Cannot connect to server. Make sure the server is running on http://127.0.0.1:8080"):t.includes("409")||t.includes("Conflict")||t.includes("already exists")?o("Username already exists. Use 'Log In' if you have an account."):t.includes("400")||t.includes("bad username")?o("Invalid username. Username must be 3-24 characters, lowercase letters, numbers, and underscores only."):t.includes("password must be at least 8")?o("Password must be at least 8 characters long."):o("Signup failed: "+t)}finally{l.disabled=!1,u.disabled=!1}});u.addEventListener("click",async()=>{F();try{const e=N.value.trim(),t=B.value.trim();if(!e||!t){o("Please enter username and password");return}l.disabled=!0,u.disabled=!0,await a("set_base",{base:m}),await a("login",{username:e,password:t,base_url:m}),await R()}catch(e){const t=e?.message||e?.toString()||String(e)||"Unknown error";console.error("Login error:",t),t.includes("Network error")||t.includes("error sending request")?o("Cannot connect to server. Make sure the server is running on http://127.0.0.1:8080"):t.includes("401")||t.includes("Invalid username or password")||t.includes("Unauthorized")?o("Invalid username or password. Please check your credentials and try again."):o("Login failed: "+t)}finally{l.disabled=!1,u.disabled=!1}});function H(){v&&clearInterval(v),v=window.setInterval(async()=>{try{const e=await a("pull_and_decrypt");e.length>0&&e.forEach(t=>{q(t,"friend")})}catch{}},1e3)}function q(e,t,r=!1){const n=document.createElement("div");n.className=`p-3 rounded ${t==="me"?"bg-blue-100 ml-auto":"bg-gray-100"} max-w-xs flex items-center gap-2`;const s=document.createElement("div");if(s.textContent=e,n.appendChild(s),t==="me"&&r){const i=document.createElement("span");i.textContent="✓",i.className="text-green-600",n.appendChild(i)}g.appendChild(n),g.scrollTop=g.scrollHeight}M.addEventListener("click",async()=>{const e=h.value,t=y.value.trim();if(!(!e||!t))try{await a("send_to_username_hpke",{username:e,plaintext:t}),q(t,"me",!1),y.value="",setTimeout(()=>{const r=g.lastElementChild;if(r&&r.textContent?.includes(t)){const n=document.createElement("span");n.textContent="✓",n.className="text-green-600 ml-2",r.appendChild(n)}},500)}catch(r){alert("Send failed: "+(r?.message||r))}});y.addEventListener("keypress",e=>{e.key==="Enter"&&M.click()});async function c(){try{const e=await a("friends_list"),t=e.filter(n=>n.status==="pending");b.innerHTML="",t.length===0?b.innerHTML='<div class="text-gray-500 text-sm">No pending requests</div>':(t.forEach(n=>{const s=document.createElement("div");s.className="flex items-center justify-between p-2 bg-yellow-50 rounded",s.innerHTML=`
          <span>${n.username}</span>
          <div class="flex gap-2">
            <button class="accept-btn px-3 py-1 bg-green-600 text-white rounded text-sm" data-username="${n.username}">Accept</button>
            <button class="reject-btn px-3 py-1 bg-red-600 text-white rounded text-sm" data-username="${n.username}">Reject</button>
          </div>
        `,b.appendChild(s)}),document.querySelectorAll(".accept-btn").forEach(n=>{n.addEventListener("click",async()=>{const s=n.getAttribute("data-username");await a("friend_respond",{from_username:s,accept:!0}),c()})}),document.querySelectorAll(".reject-btn").forEach(n=>{n.addEventListener("click",async()=>{const s=n.getAttribute("data-username");await a("friend_respond",{from_username:s,accept:!1}),c()})}));const r=e.filter(n=>n.status==="accepted");_.innerHTML="",r.length===0?_.innerHTML='<div class="text-gray-500 text-sm">No friends yet</div>':(r.forEach(n=>{const s=document.createElement("div");s.className="flex items-center justify-between p-2 bg-white border rounded",s.innerHTML=`
          <span>${n.username}</span>
          <button class="message-btn px-3 py-1 bg-blue-600 text-white rounded text-sm" data-username="${n.username}">Message</button>
        `,_.appendChild(s)}),document.querySelectorAll(".message-btn").forEach(n=>{n.addEventListener("click",()=>{const s=n.getAttribute("data-username");k("chats"),h.value=s,y.focus()})})),h.innerHTML='<option value="">Select friend...</option>',r.forEach(n=>{const s=document.createElement("option");s.value=n.username,s.textContent=n.username,h.appendChild(s)})}catch(e){console.error("Failed to refresh contacts:",e)}}G.addEventListener("click",async()=>{const e=D.value.trim();if(e)try{await a("friend_request",{to_username:e}),D.value="",c()}catch(t){alert("Failed to add friend: "+(t?.message||t))}});async function x(){try{const e=await a("get_me");K.textContent=e.username,Z.textContent=e.device_id,L=e.username,I=e.device_id}catch(e){console.error("Failed to load profile:",e)}}J.addEventListener("click",async()=>{try{const e=await a("create_invite",{friend_hint:null,ttl_minutes:60}),t=e.invite_link||e;if(!t||typeof t!="string")throw new Error("Invalid response from server: "+JSON.stringify(e));await navigator.clipboard.writeText(t),P&&(P.textContent=t),O&&O.classList.remove("hidden"),alert("Invite link copied! Share it with friends to invite them to ZeroChat.")}catch(e){console.error("Invite creation error:",e),alert("Failed to create invite: "+(e?.message||e))}});A("deeplink:provision",async e=>{const{token:t,base:r,inviter:n}=e.payload;t&&r&&await T(t,r)});A("deeplink",e=>{const t=e.payload;Q(t)});function Q(e){try{const t=new URL(e);if(t.protocol!=="zerochat:")return;if(t.hostname==="provision"){const r=t.searchParams.get("token"),n=t.searchParams.get("base"),s=t.searchParams.get("inviter");r&&T(r,n||void 0,s||void 0)}else if(t.hostname==="addfriend"){const r=t.searchParams.get("u"),n=t.searchParams.get("base");r&&(n&&a("set_base",{base:n}),a("friend_request",{to_username:r}),k("contacts"))}}catch(t){console.error("Failed to handle deeplink:",t)}}async function T(e,t,r){try{t&&await a("set_base",{base:t}),await a("provision_with_token",{token:e,base_url:t||null}),await a("upload_identity_and_keypackage"),U()}catch(n){alert("Provision failed: "+(n?.message||n))}}U();
