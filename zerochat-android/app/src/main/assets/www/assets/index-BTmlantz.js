(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}})();function R(){return window.crypto.getRandomValues(new Uint32Array(1))[0]}function v(e,t=!1){const s=R(),n=`_${s}`;return Object.defineProperty(window,n,{value:r=>(t&&Reflect.deleteProperty(window,n),e?.(r)),writable:!1,configurable:!0}),s}async function a(e,t={}){return new Promise((s,n)=>{const r=v(o=>{s(o),Reflect.deleteProperty(window,`_${i}`)},!0),i=v(o=>{n(o),Reflect.deleteProperty(window,`_${r}`)},!0);window.__TAURI_IPC__({cmd:e,callback:r,error:i,...t})})}async function C(e){return a("tauri",e)}async function F(e,t){return C({__tauriModule:"Event",message:{cmd:"unlisten",event:e,eventId:t}})}async function H(e,t,s){return C({__tauriModule:"Event",message:{cmd:"listen",event:e,windowLabel:t,handler:v(s)}}).then(n=>async()=>F(e,n))}var E;(function(e){e.WINDOW_RESIZED="tauri://resize",e.WINDOW_MOVED="tauri://move",e.WINDOW_CLOSE_REQUESTED="tauri://close-requested",e.WINDOW_CREATED="tauri://window-created",e.WINDOW_DESTROYED="tauri://destroyed",e.WINDOW_FOCUS="tauri://focus",e.WINDOW_BLUR="tauri://blur",e.WINDOW_SCALE_FACTOR_CHANGED="tauri://scale-change",e.WINDOW_THEME_CHANGED="tauri://theme-changed",e.WINDOW_FILE_DROP="tauri://file-drop",e.WINDOW_FILE_DROP_HOVER="tauri://file-drop-hover",e.WINDOW_FILE_DROP_CANCELLED="tauri://file-drop-cancelled",e.MENU="tauri://menu",e.CHECK_UPDATE="tauri://update",e.UPDATE_AVAILABLE="tauri://update-available",e.INSTALL_UPDATE="tauri://update-install",e.STATUS_UPDATE="tauri://update-status",e.DOWNLOAD_PROGRESS="tauri://update-download-progress"})(E||(E={}));async function D(e,t){return H(e,null,t)}let g=null,_="",b="";const l=document.getElementById("onboarding"),u=document.getElementById("app"),O=document.getElementById("onboardUsername"),P=document.getElementById("onboardPassword"),q=document.getElementById("onboardSignup"),T=document.getElementById("onboardLogin"),S=document.querySelectorAll(".tab-btn"),$=document.querySelectorAll(".tab-content"),m=document.getElementById("messagesList"),f=document.getElementById("chatFriend"),p=document.getElementById("chatMessage"),A=document.getElementById("chatSend"),I=document.getElementById("addFriendInput"),j=document.getElementById("addFriendBtn"),h=document.getElementById("pendingList"),y=document.getElementById("friendsListContent"),V=document.getElementById("profileUsername"),z=document.getElementById("profileDeviceId"),G=document.getElementById("copyInviteLink"),k=document.getElementById("inviteLinkDisplay"),x=document.getElementById("inviteLinkText");S.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");w(t)})});function w(e){S.forEach(t=>{t.getAttribute("data-tab")===e?(t.classList.add("border-blue-600","text-blue-600"),t.classList.remove("border-transparent","text-gray-600")):(t.classList.remove("border-blue-600","text-blue-600"),t.classList.add("border-transparent","text-gray-600"))}),$.forEach(t=>{t.id===`${e}-tab`?t.classList.remove("hidden"):t.classList.add("hidden")}),e==="contacts"&&c(),e==="profile"&&L()}const d="http://127.0.0.1:8080";async function N(){try{if(await a("set_base",{base:d}),!await a("load_creds").catch(()=>null)){l.classList.remove("hidden"),u.classList.add("hidden");return}const t=await a("get_me");_=t.username,b=t.device_id,l.classList.add("hidden"),u.classList.remove("hidden"),W(),c(),L()}catch(e){console.error("Onboarding check failed:",e),l.classList.remove("hidden"),u.classList.add("hidden")}}async function B(){await a("upload_identity_and_keypackage");const e=await a("get_me");_=e.username,b=e.device_id,l.classList.add("hidden"),u.classList.remove("hidden"),W(),c(),L()}q.addEventListener("click",async()=>{try{const e=O.value.trim(),t=P.value.trim();if(!e||!t){alert("Please enter username and password");return}if(t.length<8){alert("Password must be at least 8 characters");return}await a("set_base",{base:d}),await a("signup",{username:e,password:t,base_url:d}),await B()}catch(e){const t=e?.message||e?.toString()||String(e)||"Unknown error";console.error("Signup error:",t),t.includes("Network error")||t.includes("error sending request")?alert("Cannot connect to server. Make sure the server is running on http://127.0.0.1:8080"):t.includes("409")||t.includes("Conflict")||t.includes("already exists")?alert("Username already exists. Use 'Log In' if you have an account."):t.includes("400")||t.includes("bad username")?alert("Invalid username. Username must be 3-24 characters, lowercase letters, numbers, and underscores only."):t.includes("password must be at least 8")?alert("Password must be at least 8 characters long."):alert("Signup failed: "+t)}});T.addEventListener("click",async()=>{try{const e=O.value.trim(),t=P.value.trim();if(!e||!t){alert("Please enter username and password");return}await a("set_base",{base:d}),await a("login",{username:e,password:t,base_url:d}),await B()}catch(e){const t=e?.message||e?.toString()||String(e)||"Unknown error";console.error("Login error:",t),t.includes("Network error")||t.includes("error sending request")?alert("Cannot connect to server. Make sure the server is running on http://127.0.0.1:8080"):t.includes("401")||t.includes("Invalid username or password")||t.includes("Unauthorized")?alert("Invalid username or password. Please check your credentials and try again."):alert("Login failed: "+t)}});function W(){g&&clearInterval(g),g=window.setInterval(async()=>{try{const e=await a("pull_and_decrypt");e.length>0&&e.forEach(t=>{U(t,"friend")})}catch{}},1e3)}function U(e,t,s=!1){const n=document.createElement("div");n.className=`p-3 rounded ${t==="me"?"bg-blue-100 ml-auto":"bg-gray-100"} max-w-xs flex items-center gap-2`;const r=document.createElement("div");if(r.textContent=e,n.appendChild(r),t==="me"&&s){const i=document.createElement("span");i.textContent="✓",i.className="text-green-600",n.appendChild(i)}m.appendChild(n),m.scrollTop=m.scrollHeight}A.addEventListener("click",async()=>{const e=f.value,t=p.value.trim();if(!(!e||!t))try{await a("send_to_username_hpke",{username:e,plaintext:t}),U(t,"me",!1),p.value="",setTimeout(()=>{const s=m.lastElementChild;if(s&&s.textContent?.includes(t)){const n=document.createElement("span");n.textContent="✓",n.className="text-green-600 ml-2",s.appendChild(n)}},500)}catch(s){alert("Send failed: "+(s?.message||s))}});p.addEventListener("keypress",e=>{e.key==="Enter"&&A.click()});async function c(){try{const e=await a("friends_list"),t=e.filter(n=>n.status==="pending");h.innerHTML="",t.length===0?h.innerHTML='<div class="text-gray-500 text-sm">No pending requests</div>':(t.forEach(n=>{const r=document.createElement("div");r.className="flex items-center justify-between p-2 bg-yellow-50 rounded",r.innerHTML=`
          <span>${n.username}</span>
          <div class="flex gap-2">
            <button class="accept-btn px-3 py-1 bg-green-600 text-white rounded text-sm" data-username="${n.username}">Accept</button>
            <button class="reject-btn px-3 py-1 bg-red-600 text-white rounded text-sm" data-username="${n.username}">Reject</button>
          </div>
        `,h.appendChild(r)}),document.querySelectorAll(".accept-btn").forEach(n=>{n.addEventListener("click",async()=>{const r=n.getAttribute("data-username");await a("friend_respond",{from_username:r,accept:!0}),c()})}),document.querySelectorAll(".reject-btn").forEach(n=>{n.addEventListener("click",async()=>{const r=n.getAttribute("data-username");await a("friend_respond",{from_username:r,accept:!1}),c()})}));const s=e.filter(n=>n.status==="accepted");y.innerHTML="",s.length===0?y.innerHTML='<div class="text-gray-500 text-sm">No friends yet</div>':(s.forEach(n=>{const r=document.createElement("div");r.className="flex items-center justify-between p-2 bg-white border rounded",r.innerHTML=`
          <span>${n.username}</span>
          <button class="message-btn px-3 py-1 bg-blue-600 text-white rounded text-sm" data-username="${n.username}">Message</button>
        `,y.appendChild(r)}),document.querySelectorAll(".message-btn").forEach(n=>{n.addEventListener("click",()=>{const r=n.getAttribute("data-username");w("chats"),f.value=r,p.focus()})})),f.innerHTML='<option value="">Select friend...</option>',s.forEach(n=>{const r=document.createElement("option");r.value=n.username,r.textContent=n.username,f.appendChild(r)})}catch(e){console.error("Failed to refresh contacts:",e)}}j.addEventListener("click",async()=>{const e=I.value.trim();if(e)try{await a("friend_request",{to_username:e}),I.value="",c()}catch(t){alert("Failed to add friend: "+(t?.message||t))}});async function L(){try{const e=await a("get_me");V.textContent=e.username,z.textContent=e.device_id,_=e.username,b=e.device_id}catch(e){console.error("Failed to load profile:",e)}}G.addEventListener("click",async()=>{try{const e=await a("create_invite",{friend_hint:null,ttl_minutes:60}),t=e.invite_link||e;if(!t||typeof t!="string")throw new Error("Invalid response from server: "+JSON.stringify(e));await navigator.clipboard.writeText(t),x&&(x.textContent=t),k&&k.classList.remove("hidden"),alert("Invite link copied! Share it with friends to invite them to ZeroChat.")}catch(e){console.error("Invite creation error:",e),alert("Failed to create invite: "+(e?.message||e))}});D("deeplink:provision",async e=>{const{token:t,base:s,inviter:n}=e.payload;t&&s&&await M(t,s)});D("deeplink",e=>{const t=e.payload;K(t)});function K(e){try{const t=new URL(e);if(t.protocol!=="zerochat:")return;if(t.hostname==="provision"){const s=t.searchParams.get("token"),n=t.searchParams.get("base"),r=t.searchParams.get("inviter");s&&M(s,n||void 0,r||void 0)}else if(t.hostname==="addfriend"){const s=t.searchParams.get("u"),n=t.searchParams.get("base");s&&(n&&a("set_base",{base:n}),a("friend_request",{to_username:s}),w("contacts"))}}catch(t){console.error("Failed to handle deeplink:",t)}}async function M(e,t,s){try{t&&await a("set_base",{base:t}),await a("provision_with_token",{token:e,base_url:t||null}),await a("upload_identity_and_keypackage"),N()}catch(n){alert("Provision failed: "+(n?.message||n))}}N();
